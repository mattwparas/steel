<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Using Rust in Steel - The Steel Book</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="../highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="../tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../theme/pagetoc.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "../";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "../searchindex.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">The Steel Book</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <i class="fa fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="making-a-steel-module-in-rust"><a class="header" href="#making-a-steel-module-in-rust">Making a Steel Module in Rust</a></h1>
<p>Sometimes you may want to create a Steel module by calling Rust. This can be
useful to:</p>
<ul>
<li>Optimize a performance critical codepath with Rust.</li>
<li>Take advantage of Rust's rich ecosystem.</li>
</ul>
<p>Whatever the case, Steel provides facilities to create reusable modules based on
Rust code. This process involves compiling Rust into a <code>dylib</code>.</p>
<h2 id="guide"><a class="header" href="#guide">Guide</a></h2>
<p>In this guide, we'll make a <code>dylib</code> that will wrap the <code>sys-info</code> crate. There
are roughly 3 steps:</p>
<ol>
<li>Create a new Rust library of type "cdylib".</li>
<li>Define a module and register types and functions to it.</li>
<li>Build the Steel crate and install it to <code>$STEEL_HOME/native</code>.</li>
<li>Use the library from Steel with <code>#%require-dylib</code>.</li>
</ol>
<h3 id="creating-a-cdylib-library"><a class="header" href="#creating-a-cdylib-library">Creating a cdylib library</a></h3>
<p>To start, create a new library using <code>cargo</code>:</p>
<pre><code>$ cargo new --lib steel-sys-info
</code></pre>
<p>This should create a directory structure as follows:</p>
<pre><code>├── Cargo.toml
├── src
│   └── lib.rs
</code></pre>
<p>We'll want to make this a <code>cdylib</code> library for Steel, so we'll perform the following adjustments in <code>Cargo.toml</code>:</p>
<ol>
<li>Set the <code>crate-type</code> to <code>"cdylib"</code>.</li>
<li>Include <code>steel-core</code> with the <code>dylibs</code> feature as a dependency.</li>
<li>Include <code>abi_stable</code> as a dependency. This is required by some <code>steel-core</code>
macros.</li>
</ol>
<pre><code class="language-toml">[package]
name = "steel-sys-info"
version.workspace = true
edition = "2021"

[lib]
name = "steel_sys_info"
crate-type = ["cdylib"]

[dependencies]
# I'm running this example based on the `steel-sys-info` library found in the steel repo. If you're
# running this on your own, use whichever steel version you'd like to target and pin to that.
steel-core = { workspace = true, features = ["dylibs", "sync"] }

# Note: If you're not using the default features, and you aren't opted into the `sync` feature,
# you'll need to have the features line up here.
# steel-core = { workspace = true, features = ["dylibs"] }

abi_stable = "0.11.1"
sys-info = "0.9.1"
</code></pre>
<p>This means that when we run <code>cargo build</code> we'll produce a shared library (<code>.so</code>
file). The shared library can be loaded into other programs, Steel in our case.</p>
<h2 id="creating-a-module"><a class="header" href="#creating-a-module">Creating a module</a></h2>
<p>For the purposes of this example, we'll create a module that wraps the <code>MemInfo</code>
struct, and expose the information there. Since we'll be implementing traits
that are defined inside the <code>steel</code> crate, we'll need to create a struct to wrap
the <code>sys_info::MemInfo</code> struct:</p>
<pre><code class="language-rust noplaypen">struct MemoryInfo {
    info: sys_info::MemInfo,
}

impl MemoryInfo {
    fn total(&amp;self) -&gt; isize {
        self.info.total as isize
    }

    fn avail(&amp;self) -&gt; isize {
        self.info.avail as isize
    }

    fn free(&amp;self) -&gt; isize {
        self.info.free as isize
    }

    fn buffers(&amp;self) -&gt; isize {
        self.info.buffers as isize
    }

    fn cached(&amp;self) -&gt; isize {
        self.info.cached as isize
    }

    fn swap_total(&amp;self) -&gt; isize {
        self.info.swap_total as isize
    }

    fn swap_free(&amp;self) -&gt; isize {
        self.info.swap_free as isize
    }
}</code></pre>
<p>Now that we've done that, we can expose this to steel by implementing the
<code>Custom</code> type for the struct, and declaring an <code>FFIModule</code>:</p>
<pre><code class="language-rust noplaypen">// Using ABI Stable types is very important
use steel::{
    declare_module,
    rvals::Custom,
    steel_vm::ffi::{FFIModule, RegisterFFIFn},
};

impl Custom for MemoryInfo {}

declare_module!(create_module);

fn create_module() -&gt; FFIModule {
    let mut module = FFIModule::new("steel/sys-info");

    module.register_fn("mem-info", || MemoryInfo {
        info: sys_info::mem_info().unwrap(),
    });

    module
        .register_fn("MemoryInfo-total", MemoryInfo::total)
        .register_fn("MemoryInfo-avail", MemoryInfo::avail)
        .register_fn("MemoryInfo-free", MemoryInfo::free)
        .register_fn("MemoryInfo-buffers", MemoryInfo::buffers)
        .register_fn("MemoryInfo-cached", MemoryInfo::cached)
        .register_fn("MemoryInfo-swap-total", MemoryInfo::swap_total)
        .register_fn("MemoryInfo-swap-free", MemoryInfo::swap_free);

    module
}</code></pre>
<p>The <code>register_fn</code> API will perform all of the necessary coercions necessary to
make this as safe as possible. At the end of the day, this is FFI and we are
loading shared libraries, so there is some unsafe Rust code, however steel uses
the underlying <code>abi_stable</code> library in order to make interactions with the
shared library as safe as possible.</p>
<h3 id="installing-the-library"><a class="header" href="#installing-the-library">Installing the library</a></h3>
<p>To install the dylib in a location where the <code>steel</code> interpreter will find it,
from the root of the library just run:</p>
<pre><code>$ cargo steel-lib
</code></pre>
<p>This will build the crate, and copy the resulting dylib to <code>$STEEL_HOME/native</code>.</p>
<h3 id="using-the-library-from-steel"><a class="header" href="#using-the-library-from-steel">Using the library from Steel</a></h3>
<p>To load the library, use the syntax <code>#%require-dylib</code> - This operates similary
to a standard <code>require</code>, in that all of the modifiers you're used to using work,
such as <code>only-in</code> and <code>prefix-in</code>. However, the argument is no longer the path
to the library, but rather the name of the library without the extension. By
default, the library will be named the <code>[lib]</code> name used in the toml, prefixed
with <code>lib</code>.</p>
<pre><code class="language-scheme">(#%require-dylib "libsteel_sys_info"
                 (only-in mem-info
                          MemoryInfo-total
                          MemoryInfo-avail
                          MemoryInfo-free
                          MemoryInfo-buffers
                          MemoryInfo-cached
                          MemoryInfo-swap-total
                          MemoryInfo-swap-free))

(provide current-memory-usage memory-usage-as-percentage)

(define (current-memory-usage #:memory-info (memory-info (mem-info)))
  (- (MemoryInfo-total memory-info) (MemoryInfo-free memory-info) (MemoryInfo-cached memory-info)))

(define (memory-usage-as-percentage #:memory-info (memory-info (mem-info)))
  (/ (current-memory-usage #:memory-info memory-info) (MemoryInfo-total memory-info)))

</code></pre>
<p>This can then be installed as a library itself on the machine, and required just
like any other library, using a <code>cog.scm</code> file for the manifest.</p>
<h3 id="calling-functions-from-the-host"><a class="header" href="#calling-functions-from-the-host">Calling functions from the host</a></h3>
<p>It might prove to be useful to be able to call an arbitrary steel function from the host,
such as a logger or just some function define in steel code. You can do this using the
<code>HostRuntimeFunction</code> struct, like so:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>static LOGGER: OnceLock&lt;HostRuntimeFunction&gt; = OnceLock::new();

declare_module!(create_module);

fn register_logger_interface(host: HostRuntimeFunction) {
    LOGGER.set(host).ok().unwrap();
}

fn log(value: String) {
    LOGGER
        .get()
        .unwrap()
        .call(RSliceMut::from_mut_slice(&amp;mut [FFIValue::StringV(
            RString::from(value),
        )]))
        .unwrap();
}

fn test_logging() {
    log("Hello world from dylib".to_string());
}

fn create_module() -&gt; FFIModule {
    let mut module = FFIModule::new("steel/sys-info");

    module
        .register_fn("register-logger", register_logger_interface)
        .register_fn("test-logging", test_logging);

    module
}
<span class="boring">}</span></code></pre></pre>
<pre><code class="language-scheme">(require-builtin steel/ffi)

(#%require-dylib "libsteel_sys_info"
                 (only-in register-logger test-logging))


;; Assuming our function is `log::info!` or whatever we want to use here
(register-logger (function-&gt;ffi-function (lambda (line) (log::info! (to-string line)))))
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../start/standalone.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../start/embedded.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../start/standalone.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../start/embedded.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->
        <script src="../theme/pagetoc.js"></script>



    </div>
    </body>
</html>
